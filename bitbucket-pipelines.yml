# Bitbucket Pipelines Configuration for PR Code Review
#
# Required Repository Variables:
#   - GH_COPILOT_TOKEN: GitHub token with Copilot access
#   - BITBUCKET_TOKEN: App password with PR write access (or use built-in)
#
# Note: BITBUCKET_WORKSPACE and BITBUCKET_REPO_SLUG are automatically provided

image: node:20

pipelines:
  pull-requests:
    '**':
      - step:
          name: Automated Code Review
          script:
            # Install GitHub CLI
            - curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            - chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg
            - echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            - apt-get update && apt-get install -y gh

            # Install Copilot extension
            - gh extension install github/gh-copilot

            # Run the review script
            - chmod +x ./scripts/review-pr.sh

            - export PLATFORM=bitbucket
            - export BITBUCKET_WORKSPACE=$BITBUCKET_WORKSPACE
            - export BITBUCKET_REPO_SLUG=$BITBUCKET_REPO_SLUG
            - export PR_NUMBER=$BITBUCKET_PR_ID
            - export GH_TOKEN=$GH_COPILOT_TOKEN
            - export REVIEW_COMMAND="gh copilot explain"
            - export REVIEW_ARGS=""

            - ./scripts/review-pr.sh
