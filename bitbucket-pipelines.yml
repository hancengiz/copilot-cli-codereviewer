# Bitbucket Pipelines Configuration for PR Code Review
#
# Required Repository Variables:
#   - GH_COPILOT_TOKEN: Fine-grained GitHub PAT with "Copilot Requests: Read" permission
#   - BITBUCKET_TOKEN: App password with PR write access (or use built-in)
#
# Note: BITBUCKET_WORKSPACE and BITBUCKET_REPO_SLUG are automatically provided

image: node:20

pipelines:
  pull-requests:
    '**':
      - step:
          name: Automated Code Review
          script:
            # Install GitHub Copilot CLI
            - npm install -g @github/copilot
            - copilot --version

            # Run the review script
            - chmod +x ./scripts/review-pr.sh

            - export PLATFORM=bitbucket
            - export BITBUCKET_WORKSPACE=$BITBUCKET_WORKSPACE
            - export BITBUCKET_REPO_SLUG=$BITBUCKET_REPO_SLUG
            - export PR_NUMBER=$BITBUCKET_PR_ID
            - export COPILOT_GITHUB_TOKEN=$GH_COPILOT_TOKEN
            - export COPILOT_MODEL=claude-sonnet-4

            - ./scripts/review-pr.sh
